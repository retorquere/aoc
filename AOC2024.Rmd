---
title: "Advent of Code 2024"
author: "Emiliano Heyns"
date: "2024-12-02"
output: html_document
---

```{r setup, include=FALSE}
if (!requireNamespace('here', quietly = TRUE)) { install.packages('here') }
library(here)
if (!requireNamespace('dplyr', quietly = TRUE)) { install.packages('dplyr') }
library(dplyr)
if (!requireNamespace('reshape', quietly = TRUE)) { install.packages('reshape') }
library(reshape)
if (!requireNamespace('igraph', quietly = TRUE)) { install.packages('igraph') }
library(igraph)
if (!requireNamespace('glue', quietly = TRUE)) { install.packages('glue') }
library(glue)

knitr::opts_chunk$set(echo = FALSE)
script_dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
knitr::opts_knit$set(root.dir = script_dir)
```

## Day 1

```{r, eval=FALSE}
df <- read.table(here('01/part1.txt'), header = FALSE, sep = '', stringsAsFactors = FALSE)
df <- as.data.frame(apply(df, 2, sort))

df$diff = abs(df$V1 - df$V2)

cat('1.1', sum(df$diff))

df <- df %>% mutate(occurrences = sapply(V1, function(x) sum(V2 == x)))
df$similarity <- df$V1 * df$occurrences

cat('1.2', sum(df$similarity))
```

## Day 2
```{r, eval=FALSE}
lines <- readLines(here('02/data.txt'), warn=FALSE)
lines <- strsplit(lines, ' ')
max_level <- max(sapply(lines, length))

lines <- lapply(lines, function(x) {
  length(x) <- max_level
  return(x)
})

df <- as.data.frame(do.call(rbind, lines), stringsAsFactors = FALSE)
df[] <- lapply(df, as.numeric)

colnames(df) <- paste0('level', seq_len(ncol(df)))
df$report <- seq_len(nrow(df))

safe <- function(x) {
  diffs <- diff(na.omit(x))
  all(diffs > 0 & diffs <= 3) || all(diffs < 0 & diffs >= -3)
}

levelcols <- df[, grepl('^level', names(df))]
df$safe <- apply(levelcols, 1, safe)
cat('2.1', nrow(subset(df, safe == TRUE)))

dampened <- df
for (level_col in grep('^level', names(df), value = TRUE)) {
  dampen <- df
  dampen[[level_col]] <- NA
  dampened <- rbind(dampened, dampen)
}
levelcols <- dampened[, grepl('^level', names(dampened))]
dampened$safe <- apply(levelcols, 1, safe)
dampened <- dampened[dampened$safe == TRUE, ]
cat('2.2', length(unique(dampened$report)))
```

## Day 3
```{r, eval=FALSE}
program <- paste(readLines(here('03/data.txt'), warn=FALSE), collapse = '\n')
matches <- gregexpr("mul[(](\\d+),(\\d+)[)]|do[(][)]|don't[(][)]", program, perl = TRUE)
numbers <- regmatches(program, matches)[[1]]
active <- TRUE
numbers <- Filter(function(x) {
  if (startsWith(x, 'do')) {
    active <<- (x == 'do()')
    return(FALSE)
  }
  else {
    return(active)
  }
}, numbers)
result <- lapply(numbers, function(x) {
  as.numeric(unlist(strsplit(gsub('mul\\(|\\)', '', x), ',')))
})
df <- do.call(rbind, result) %>% as.data.frame()
df$mul = df$V1 * df$V2
cat('3', sum(df$mul))
```

## Day 4

```{r, eval=FALSE}
data <- gsub('\n', ' ', readLines(here('04/data.txt'), warn = FALSE))
columns <- nchar(data[[1]])
data <- paste(data, collapse = ' ')

xmas <- 0
for (word in c('XMAS', 'SAMX')) {
  word <- strsplit(word, '')[[1]]
  for (space in c(0, columns, columns + 1, columns - 1)) {
    pattern <- paste(word, collapse = sprintf('.{%d}', space))
    pattern <- gsub('.{0}', '', pattern)
    pattern <- sub('^(.)(.+)', '\\1(?=\\2)', pattern)
    xmas <- xmas + length(unlist(gregexpr(pattern, data, perl=TRUE)))
  }
}
print(xmas)

xmas <- 0
other <- list(M = 'S', S = 'M')
letter <- names(other)
for (i in 0:3) {
  tl <- letter[(i %% 2) + 1]
  tr <- letter[((i %/% 2) %% 2) + 1]
  bl <- other[[tr]]
  br <- other[[tl]]
  pattern <- str_glue('{tl}(?=.{tr}.{columns-1}A.{columns-1}{bl}.{br})')
  xmas <- xmas + length(unlist(gregexpr(pattern, data, perl=TRUE)))
}
print(xmas)
```

## Day 5

```{r}
input_data <- readLines(here('05/data.txt'), warn=FALSE)

split_index <- which(input_data == '')
data_part1 <- input_data[1:(split_index - 1)]
data_part2 <- input_data[(split_index + 1):length(input_data)]

ordering <- read.table(text = paste(data_part1, collapse = '\n'), sep = '|', header = FALSE, stringsAsFactors = FALSE)
colnames(ordering) <- c('before', 'after')

# Read the second part into a dataframe with variable number of columns
lines <- strsplit(data_part2, ',')
max_cols <- max(sapply(lines, length))
padded_lines <- lapply(lines, function(x) {
  length(x) <- max_cols
  x
})
updates <- as.data.frame(do.call(rbind, padded_lines), stringsAsFactors = FALSE)

is_ordered <- function(row) {
  row <- row[!is.na(row)]
  subordering <- ordering[ordering$before %in% row, ]
  g <- graph_from_data_frame(subordering, directed = TRUE)
  sort_order <- as.numeric(vertex_attr(g, 'name', index = topo_sort(g, mode = 'out')))
  
  if (length(setdiff(row, sort_order)) > 0) return(NA)
  indices <- match(row, sort_order)
  return(all(diff(indices) > 0))  # Check if indices are in increasing order
}

updates$ordered <- apply(updates, 1, is_ordered)

calculate_middle <- function(row) {
  if (row['ordered']) {
    values <- as.numeric(row[grep('^V', names(row))])
    values <- values[!is.na(values)] 
    return(values[ceiling(length(values) / 2)])
  } else {
    return(NA)
  }
}

updates$middle <- apply(updates, 1, calculate_middle)
print(sum(updates$middle[updates$ordered]))

unordered <- updates[updates$ordered == FALSE, ]
unordered <- unordered[, grep('^V', names(unordered))]

ordered_middle <- function(row) {
  row <- row[!is.na(row)]
  subordering <- ordering[ordering$before %in% row, ]
  g <- graph_from_data_frame(subordering, directed = TRUE)
  sort_order <- as.numeric(vertex_attr(g, 'name', index = topo_sort(g, mode = 'out')))
  row <- row[order(match(row, sort_order))]
  return(row[ceiling(length(row) / 2)])
}
unordered$middle <- as.numeric(apply(unordered, 1, ordered_middle))
print(sum(unordered$middle))
```

## Day 6

```{r}
M <- do.call(rbind, strsplit(readLines(here('24/06/data.txt'), warn=FALSE), ""))
M <- rbind(rep(NA, ncol(M)), M, rep(NA, ncol(M)))
M <- cbind(rep(NA, nrow(M)), M, rep(NA, nrow(M)))
startpos <- list(
  "^" = matrix(c(-1, 0), nrow=1),
  ">" = matrix(c(0, 1), nrow=1),
  "v" = matrix(c(1, 0), nrow=1),
  "<" = matrix(c(0, -1), nrow=1)
)
rightturn <- function(direction) {
  return(direction %*%  matrix(c(0, 1, -1, 0), ncol=2))
}
side <- c(
  '-1,0' = 1,
  '0,1' = 2,
  '1,0' = 4,
  '0,-1' = 8
)
start <- list(
  pos = which(M=='^' | M=='v' | M == '>' | M == '<',arr.ind=TRUE)
)
start$dir <- startpos[[M[start$pos]]]
M[start$pos] <- side[paste(start$dir, collapse=',')]
M[M == '.'] <- 0

walk <- function(m) {
  guard <- start
  while (TRUE) {
    while (!is.na(m[guard$pos + guard$dir]) && (m[guard$pos + guard$dir] == '#')) { # turn as much as required
      guard$dir <- rightturn(guard$dir)
    }
    origin <- guard
    guard$pos <- guard$pos + guard$dir # actually move

    if (is.na(m[guard$pos])) return(list(M=m, loop=FALSE)) # end of shift

    if (bitwAnd(as.integer(m[guard$pos]), side[paste(guard$dir, collapse=',')]) != 0) { # loop: been here before, in this direction
      return(list(M=m, loop=TRUE))
    }
    m[guard$pos] <- bitwOr(as.integer(m[guard$pos]), side[paste(guard$dir, collapse=',')]) # mark
  }
}

walked <- walk(M)

# we have actually visited all these points
visited <- apply(walked$M, c(1, 2), function(x) { v <- suppressWarnings(as.integer(x)); ifelse(v == 0, NA, v) })
visited <- which(!is.na(visited), arr.ind = TRUE)
print(nrow(visited))
obstructions <- 0
for (i in 1:nrow(visited)) {
  obstruction <- visited[i, , drop = FALSE]
  if (!identical(obstruction, start$pos)) {
    #cat('testing', i, paste(obstruction, collapse =','), '\n')
    diverted <- M
    diverted[obstruction] <- '#'
    if (walk(diverted)$loop) obstructions <- obstructions + 1
  }
}
print(obstructions)
```